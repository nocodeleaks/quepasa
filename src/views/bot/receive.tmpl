{{ define "content" }}
  {{ $DOWNLOADPREFIX := .DownloadPrefix }}
  {{ if .ErrorMessage }}
    <div class="notification is-warning">
      {{ .ErrorMessage }}
    </div>
  {{ end }}

  <div class="container is-fluid container-receive">
    <h2 class="title is-2">({{ .Count }}) Messages for {{ .Number }}</h2>
    <details class="receive-filters"{{ if or .SearchFilter .CategoryFilter .TypeFilter .ExceptionsFilter .FromMeFilter .FromHistoryFilter .ChatIDFilter .MessageIDFilter .TrackIDFilter .TimestampFilter .LastFilter }} open{{ end }}>
      <summary class="receive-filters-summary">
        <span class="receive-filters-title">Filters</span>
        <span class="receive-filters-active">
          {{ if .SearchFilter }}<span class="tag is-info is-light">search</span>{{ end }}
          {{ if .CategoryFilter }}<span class="tag is-info is-light">category: {{ .CategoryFilter }}</span>{{ end }}
          {{ if .TypeFilter }}<span class="tag is-info is-light">type: {{ .TypeFilter }}</span>{{ end }}
          {{ if .ExceptionsFilter }}<span class="tag is-info is-light">exceptions: {{ .ExceptionsFilter }}</span>{{ end }}
          {{ if .FromMeFilter }}<span class="tag is-info is-light">fromme: {{ .FromMeFilter }}</span>{{ end }}
          {{ if .FromHistoryFilter }}<span class="tag is-info is-light">fromhistory: {{ .FromHistoryFilter }}</span>{{ end }}
          {{ if .ChatIDFilter }}<span class="tag is-info is-light">chatid</span>{{ end }}
          {{ if .MessageIDFilter }}<span class="tag is-info is-light">messageid</span>{{ end }}
          {{ if .TrackIDFilter }}<span class="tag is-info is-light">trackid</span>{{ end }}
          {{ if .TimestampFilter }}<span class="tag is-info is-light">timestamp</span>{{ end }}
          {{ if .LastFilter }}<span class="tag is-info is-light">last</span>{{ end }}
        </span>
      </summary>

      <form method="get" action="/form/server/{{ .Token }}/receive" class="receive-filters-body">
        <div class="field">
          <label class="label" for="search">Search (id, text, chat, participant, exceptions)</label>
          <div class="control">
            <input id="search" class="input" type="text" name="search" value="{{ .SearchFilter }}" placeholder="Search in cached messages">
          </div>
        </div>

        <div class="receive-filters-grid">
          <div class="control">
            <label class="label" for="category">Category</label>
            <div class="select is-fullwidth">
              <select id="category" name="category">
                <option value=""{{ if eq .CategoryFilter "" }} selected{{ end }}>All</option>
                <option value="received"{{ if eq .CategoryFilter "received" }} selected{{ end }}>Received</option>
                <option value="sent"{{ if eq .CategoryFilter "sent" }} selected{{ end }}>Sent</option>
                <option value="sync"{{ if eq .CategoryFilter "sync" }} selected{{ end }}>Sync Events</option>
                <option value="unhandled"{{ if eq .CategoryFilter "unhandled" }} selected{{ end }}>Unhandled</option>
                <option value="events"{{ if eq .CategoryFilter "events" }} selected{{ end }}>All Events</option>
              </select>
            </div>
          </div>

          <div class="control">
            <label class="label" for="type">Type</label>
            <div class="select is-fullwidth">
              <select id="type" name="type">
                <option value=""{{ if eq .TypeFilter "" }} selected{{ end }}>All</option>
                <option value="text"{{ if eq .TypeFilter "text" }} selected{{ end }}>text</option>
                <option value="image"{{ if eq .TypeFilter "image" }} selected{{ end }}>image</option>
                <option value="document"{{ if eq .TypeFilter "document" }} selected{{ end }}>document</option>
                <option value="audio"{{ if eq .TypeFilter "audio" }} selected{{ end }}>audio</option>
                <option value="video"{{ if eq .TypeFilter "video" }} selected{{ end }}>video</option>
                <option value="location"{{ if eq .TypeFilter "location" }} selected{{ end }}>location</option>
                <option value="contact"{{ if eq .TypeFilter "contact" }} selected{{ end }}>contact</option>
                <option value="call"{{ if eq .TypeFilter "call" }} selected{{ end }}>call</option>
                <option value="system"{{ if eq .TypeFilter "system" }} selected{{ end }}>system</option>
                <option value="group"{{ if eq .TypeFilter "group" }} selected{{ end }}>group</option>
                <option value="revoke"{{ if eq .TypeFilter "revoke" }} selected{{ end }}>revoke</option>
                <option value="poll"{{ if eq .TypeFilter "poll" }} selected{{ end }}>poll</option>
                <option value="view_once"{{ if eq .TypeFilter "view_once" }} selected{{ end }}>view_once</option>
                <option value="unhandled"{{ if eq .TypeFilter "unhandled" }} selected{{ end }}>unhandled</option>
              </select>
            </div>
          </div>

          <div class="control">
            <label class="label" for="exceptions">Exceptions</label>
            <div class="select is-fullwidth">
              <select id="exceptions" name="exceptions">
                <option value=""{{ if eq .ExceptionsFilter "" }} selected{{ end }}>All</option>
                <option value="true"{{ if eq .ExceptionsFilter "true" }} selected{{ end }}>Only Errors</option>
                <option value="false"{{ if eq .ExceptionsFilter "false" }} selected{{ end }}>Without Errors</option>
              </select>
            </div>
          </div>

          <div class="control">
            <label class="label" for="fromme">FromMe</label>
            <div class="select is-fullwidth">
              <select id="fromme" name="fromme">
                <option value=""{{ if eq .FromMeFilter "" }} selected{{ end }}>All</option>
                <option value="true"{{ if eq .FromMeFilter "true" }} selected{{ end }}>true</option>
                <option value="false"{{ if eq .FromMeFilter "false" }} selected{{ end }}>false</option>
              </select>
            </div>
          </div>

          <div class="control">
            <label class="label" for="fromhistory">FromHistory</label>
            <div class="select is-fullwidth">
              <select id="fromhistory" name="fromhistory">
                <option value=""{{ if eq .FromHistoryFilter "" }} selected{{ end }}>All</option>
                <option value="true"{{ if eq .FromHistoryFilter "true" }} selected{{ end }}>true</option>
                <option value="false"{{ if eq .FromHistoryFilter "false" }} selected{{ end }}>false</option>
              </select>
            </div>
          </div>

          <div class="control">
            <label class="label" for="chatid">Chat ID</label>
            <input id="chatid" class="input" type="text" name="chatid" value="{{ .ChatIDFilter }}" placeholder="5511...@s.whatsapp.net">
          </div>

          <div class="control">
            <label class="label" for="messageid">Message ID</label>
            <input id="messageid" class="input" type="text" name="messageid" value="{{ .MessageIDFilter }}" placeholder="ABCD...">
          </div>

          <div class="control">
            <label class="label" for="trackid">Track ID</label>
            <input id="trackid" class="input" type="text" name="trackid" value="{{ .TrackIDFilter }}" placeholder="your-system-id">
          </div>

          <div class="control">
            <label class="label" for="timestamp">Timestamp</label>
            <input id="timestamp" class="input" type="text" name="timestamp" value="{{ .TimestampFilter }}" placeholder="unix timestamp">
          </div>

          <div class="control">
            <label class="label" for="last">Last Minutes</label>
            <input id="last" class="input" type="text" name="last" value="{{ .LastFilter }}" placeholder="e.g. 60">
          </div>
        </div>

        <div class="field is-grouped">
          <div class="control">
            <button type="submit" class="button is-info">Apply Filters</button>
          </div>
          <div class="control">
            <a class="button is-light" href="/form/server/{{ .Token }}/receive">Clear</a>
          </div>
        </div>
      </form>
    </details>

    <div class="messages">
      {{ range .Messages }}
      <div class="message{{ if .HasExceptions }} dispatch-error{{ end }}">
        <pre id="msg-{{ .Id }}">
          On: {{ .Timestamp }} => ID: {{ .Id }} => From Me: {{ .FromMe }}{{ if .HasStatus }} => Status: {{ .Status }}{{ end }} => Edited: {{ .Edited }}{{ if .HasAttachment }} => Attachment: <a download target="_blank" style="color: {{ if .Attachment.IsValidSize }}blue{{ else }}red{{ end }};" title="{{ .Attachment.Mimetype }} {{ if .Attachment.FileName }}({{ .Attachment.FileName }}) {{ end }}:: {{ .Attachment.FileLength }} bytes" href="{{ $DOWNLOADPREFIX }}{{ .Id }}">Download</a>{{ end }}
          Type: {{ .Type }} => Chat: {{ .Chat.Id }}{{ if .Chat.Phone }} [{{ .Chat.Phone }}]{{ end }}{{ if .Chat.LId }} LId: {{ .Chat.LId }}{{ end }}{{ if .Chat.Title }} ({{ .Chat.Title }}){{ end }}{{ if .Participant }}{{ if .FromHistory }} (From History){{ end }}{{ if .FromAds }} (From Ads){{ end }}
          Participant: {{ .Participant.Id }}{{ if .Participant.Phone }} [{{ .Participant.Phone }}]{{ end }}{{ if .Participant.LId }} LId: {{ .Participant.LId }}{{ end }}{{ if .Participant.Title }} ({{ .Participant.Title }}){{ end }}{{ end }}{{ if .TrackId }}
          TrackId:  {{ .TrackId }}{{ end }}{{ if .InReply }}
          InReply:  <a href="#msg-{{ .InReply }}">{{ .InReply }}</a>{{ end }}{{ if .HasExceptions }} => <span style="color: red; font-weight: bold;">DISPATCH ERROR</span>{{ end }}{{ if .Text }}
          Text: {{ .Text }}{{ end }}
        </pre>
        {{ if .HasExceptions }}
        <div class="dispatch-errors" style="background-color: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 10px; margin: 5px 0;">
          <div style="color: #c62828; font-weight: bold; margin-bottom: 5px;">ðŸš¨ Dispatch Errors:</div>
          <ul style="color: #d32f2f; margin: 0; padding-left: 20px;">
            {{ range .Exceptions }}
            <li>{{ . }}</li>
            {{ end }}
          </ul>
        </div>
        {{ end }}
        {{ if .Url }}
          <div title="Url" class="url">
            <div class="header">Url</div>
            <div class="title">Title: <span>{{ .Url.Title }}</span></div>
            <div class="description">Description: <span>{{ .Url.Description }}</span></div>
            <div class="reference">Reference: <a href="{{ .Url.Reference }}">{{ .Url.Reference }}</a></div>

            {{ if .Url.Thumbnail }}
            <div title="Url Thumbnail" class="url-thumbnail">
              <div class="header">Url Thumbnail</div>
              <img src="{{ .Url.Thumbnail.GetThumbnailAsUrl|safeURL }}" />
            </div>
          {{ end }}
          </div>
        {{ end }}
        {{ if .Attachment }}
          {{ if .Attachment.Thumbnail }}
            <div title="Attachment Thumbnail" class="thumbnail">
              <div class="header">Attachment Preview</div>
              <img src="{{ .Attachment.Thumbnail.GetThumbnailAsUrl|safeURL }}" />
            </div>
          {{ end }}
        {{ end }}
      </div>
      {{ end }}
    </div>
    <a style="padding: 2rem;" href="/form/account">Back</a>
  </div>
  <link href="/assets/css/container-receive.css" rel="stylesheet">
{{ end }}
